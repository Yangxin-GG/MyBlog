{% extends "visitor/base.html" %}

{% block title %}
{{ article.title }}
{% endblock title %}

{% block css %}
<script src='/js/highlight.pack.js'></script>
<script src="/js/arttemplate.js"></script>
<script src="/js/wangEditor.min.js"></script>
<script src="/js/customize/index_command.js"></script>
<link href='/css/monokai_default.css' rel='stylesheet' />
<style>
    pre {
        padding: 0px;
    }
    .comment li p a {
        color: #ff7519;
        margin-right: 10px;
        text-decoration: none;
    }
    .comment li p.head {
        line-height: 20px;
        font-size: 14px;
        color: #8c8c8c;
    }
    .comment li {
        margin-top: 30px;
        border-bottom: 1px solid #e6e6e6;
        overflow: hidden;
    }
    .comment_ground {
        background: floralwhite;
    }
</style>
{% endblock css %}

{% block header %}
<div class="img">
    <img src="/images/img_12.JPG" class="img-responsive img-rounded"/><br>
    <p class="text-right">--- 摄于 2017 年 9 月 藏川线前段</p>
</div>
{% endblock header%}

{% block body %}
<div class="col-sm-offset-1 col-sm-10 col-md-offset-1 col-md-10 col-xs-offset-1 col-xs-10" data-id={{ article.id }}>

</div>
<div class="col-sm-offset-1 col-sm-10 col-md-offset-1 col-md-10 col-xs-offset-1 col-xs-10 comment_ground">
    <h4>评论区</h4>
    <ul class="comment">

    </ul>

    <a id="load" style="display:block;cursor: pointer;"><p class="text-center">加载更多</p></a>
</div>
<div class="alert alert-success col-md-offset-8 col-md-3" style="display: none; margin-top: 20px;">
    提交成功。
</div>
<div class="alert alert-danger col-md-offset-8 col-md-3" style="display: none; margin-top: 20px;">
    似乎存在一些故障
</div>
{% if user %}
<div class="col-sm-offset-1 col-sm-10 col-md-offset-1 col-md-10 col-xs-offset-1 col-xs-10" style="margin-top: 20px;">
    <div id="editor">

    </div>

    <button class="btn btn-primary pull-right comment">评论</button>
</div>
{% endif %}

{% endblock body %}

{% block script %}
{% if user %}
<script>
    "use strict";
    var editor = new wangEditor('#editor');
    editor.create();
    $(".w-e-text-container").css({"height":"100px", "z-index": ""});
    $("button.comment").click(function () {
        if (editor.txt.text() !== "") {
            var comment = editor.txt.html();
            var article_id = $(".col-md-offset-1[data-id]").attr("data-id");
            $.ajax({
                url: "/api/v1/comment/new",
                type: "post",
                dataType: "json",
                data: JSON.stringify({"comment": comment, "article_id": article_id}),
                headers: {"Content-Type": "application/json"},
                success: function (res) {
                    if (res.status) {
                        $(".alert-success").css("display", "block");
                        editor.txt.clear();
                        window.setTimeout(closeInfo, 3000);
                        $("ul.comment").empty();
                        $("#load").children().text("加载更多");
                        command.clear();
                        getComments();
                    } else {
                        $(".alert-danger").css("display", "block");
                        window.setTimeout(closeInfo, 3000);
                    }
                }
            })
        }
    });
    function closeInfo() {
        $(".alert").css("display", "none")
    }
</script>
{% endif %}
<script>
    "use strict";
    $(function() {
        getArticle();
        getComments();
        command.statusChange();
    });

    $("#load").click(function () {
        command.statusChange();
        getComments();
    });

    // todo: finish it
    $("body").on("click", "ul.comment li a.delete", function () {
        console.log("delete")
    });

    $("body").on("click", "ul.comment li a.reply", function () {
        console.log("reply")
    });

    function getArticle() {
        var id = $(".col-md-offset-1[data-id]").attr("data-id");
        $.getJSON("/api/v1/article/view?id=" + id, function (result) {
            $(".col-md-offset-1[data-id]").append(result.data.content);
            $('pre code').each(function(i, block) {
                hljs.highlightBlock(block);
            });
            $(".col-md-offset-1[data-id]")
                .append("<blockquote class='pull-right'><h5 class='post-meta'>Last Modified:</h5>" +
                    "<p class='pull-right post-meta'>" + moment.utc(result.data.modify_time).local().format() +
                    "</p></blockquote>");
            var tags = {data: []};

            $.each(result.data.tags, function (index, value) {
                if (value !== null) {
                    tags.data.push([result.data.tags_id[index], value])
                }
            });
            var html = template("tpl-tag-list", tags);
            $(".col-md-offset-1[data-id]").children().first().after(html)
        });
    }

    function getComments() {
        if (command.command) {
            var id = $(".col-md-offset-1[data-id]").attr("data-id");
            $.getJSON("/api/v1/article/view_comment/" + id + "?limit=5&&offset=" + command.order * 5, function (result) {
                command.add();
                if (result.data.length < 5) {
                    command.change();
                    $("#load").children().text("没有更多了");
                }
                for (var index in result.data) {
                    result.data[index].create_time = moment.utc(result.data[index].create_time).local().format();
                    result.data[index]["admin"] = result.admin;
                    if (result.user) {
                        result.data[index]["user"] = result.user.id;
                    }
                }
                var html = template("tpl-comment-list", result);
                $("ul.comment").append(html);
                command.statusChange();
            })
        }
    }
</script>
<script id="tpl-tag-list" type="text/html">
    {% raw %}
    <div style="margin-bottom: 10px;">
        {{each data }}
        <span class='label label-info' tag-id={{ $value[0] }}><span class='glyphicon glyphicon-tags' style='margin-right: 5px;'></span>{{ $value[1] }}</span>
        {{/each }}
    </div>
    {% endraw %}
</script>
<script src="/js/customize/navigationBar.js"></script>
<script id="tpl-comment-list" type="text/html">
    {% raw %}
    {{ each data }}
        {{ set temp = $value.comment }}
        <li class="list-unstyled">
            <p class="head"><a href="/user/{{ $value.user_id }}">{{ $value.user_nickname }}</a><span>{{ $value.create_time }}</span></p>
            <div>
                {{@temp}}
            </div>
            {{ if $value.user === $value.user_id || $value.admin }}
            <a class="pull-right delete" style="cursor: pointer;color: #777; margin-right: 10px;">删除</a>
            {{ /if }}

            {{ if $value.admin || ($value.user !== $value.user_id && $value.user !== undefined ) }}
            <a class="pull-right reply" style="margin-right: 10px; cursor: pointer;color: #777;">回复</a>
            {{ /if }}
        </li>
    {{ /each }}
    {% endraw %}
</script>
{% endblock script%}
