{% extends "admin/admin_base.html" %}

{% block title %}
Users
{% endblock title %}

{% block css %}
<script src="/js/arttemplate.js"></script>
{% include "template/user_list.html" %}
{% endblock css %}

{% block body %}
<div class="col-sm-offset-1 col-sm-10 col-md-offset-1 col-md-10 col-xs-offset-1 col-xs-10" style="margin-top: 100px">
    <div class="container col-sm-12 col-md-12 col-xs-12">
        <table class="table table-striped">
            <thead>
            <tr>
                <th>序号</th>
                <th>账号</th>
                <th>昵称</th>
                <th>权限</th>
                <th>Email</th>
                <th>创建时间</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
    <div class="text-center">
        <nav aria-label="Page navigation">
            <ul class="pagination">

                <li class="previous">
                    <button class="btn btn-default" id="previous" disabled><span aria-hidden="true">&larr;</span>
                        Previous
                    </button>
                </li>
                <li class="next">
                    <button class="btn btn-default" id="next">Next <span aria-hidden="true">&rarr;</span></button>
                </li>

            </ul>
        </nav>
    </div>
</div>
<div id="delete_modal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">提示</h4>
            </div>
            <div class="modal-body">
                <p>确认要删除吗？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger modal-delete" data-dismiss="modal">Yes</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock body %}

{% block script %}
<script>
    "use strict";
    $(function () {
        getUserList();
    });

    function getUserList() {
        $.getJSON("/api/v1/user/view_all?limit=10&&offset=" + page.page * 10, function (result) {
            if (result.data.length < 10) {
                $("#next").attr({"disabled": "disabled"});
            }
            for (var index in result.data) {
                result.data[index].create_time = moment.utc(result.data[index].create_time).local().format();
                if (result.data[index].groups === 0) {
                    result.data[index].group_name = "Admin"
                } else {
                    result.data[index].group_name = "User"
                }
            }
            var html = template("tpl-user-list", result);
            $("tbody").append(html);
            deleteButton();
            permissionButton();
        });

    }

    function deleteButton() {
        $(".delete").on("click", function (event) {
            event.preventDefault();
            $("#delete_modal").modal("show");
            var tr = $(this).parent().parent();
            var id = $(this).attr("data-id");
            $(".modal-delete").click(function () {
                $.ajax({
                    url: "/api/v1/user/delete/" + id,
                    type: "post",
                    dataType: "json",
                    data: "",
                    headers: {"Content-Type": "application/json"},
                    success: function (res) {
                        if (res.status) {
                            tr.hide(1000, function () {
                                tr.remove()
                            })
                        }
                    }
                })
            })
        })
    }
    
    function permissionButton() {
        $(".permission").on("click", function (event) {
            event.preventDefault();
            var permission = $(this).parent().prev().prev().prev().children().attr("data-id") === "1" ? 0 : 1;
            var permission_element = $(this).parent().prev().prev().prev().children();
            var id = $(this).attr("data-id");
            $.ajax({
                url: "/api/v1/user/permission",
                type: "post",
                dataType: "json",
                data: JSON.stringify({ "id": id, "permission": permission }),
                headers: {"Content-Type": "application/json"},
                success: function (res) {
                    if (res.status) {
                        permission_element.attr("data-id", permission);
                        if (permission === 0) {
                            permission_element.text("Admin")
                        } else {
                            permission_element.text("User")
                        }
                    }
                }
            })
        })
    }

    $("#previous").click(function (event) {
        event.preventDefault();
        page.sub();
        $("#next").removeAttr("disabled");
        if (page.page === 0) {
            $("#previous").attr({"disabled": "disabled"});
        }
        $("tbody").html("");
        getUserList();
    });

    $("#next").click(function (event) {
        event.preventDefault();
        page.add();
        if (page.page > 0) {
            $("#previous").removeAttr("disabled");
        }
        $("tbody").html("");
        getUserList();
    });

    function Page() {
        this.page = 0;
        this.add = function () {
            this.page += 1;
        };
        this.sub = function () {
            this.page -= 1;
        }
    }

    var page = new Page();
</script>
{% endblock script %}
