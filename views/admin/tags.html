{% extends "admin/admin_base.html" %}

{% block title %}
Tags
{% endblock title %}

{% block css %}
<script src="/js/arttemplate.js"></script>
{% include "template/tag_list.html" %}
{% endblock css %}

{% block body %}
<div class="col-sm-offset-1 col-sm-10 col-md-offset-1 col-md-10 col-xs-offset-1 col-xs-10" style="margin-top: 50px">

    <button type="button" class="btn btn-success pull-right">
        <span class="glyphicon glyphicon-plus"></span>
        New
    </button>
    <br/>
    <hr/>
    <div class="container col-sm-12 col-md-12 col-xs-12">
        <table class="table table-striped">
            <thead>
            <tr>
                <th>序号</th>
                <th>标签名</th>
                <th>使用数</th>
                <th>操作</th>
            </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
    <div class="text-center">
        <nav aria-label="Page navigation">
            <ul class="pagination">

                <li class="previous">
                    <button class="btn btn-default" id="previous" disabled><span aria-hidden="true">&larr;</span>
                        Previous
                    </button>
                </li>
                <li class="next">
                    <button class="btn btn-default" id="next">Next <span aria-hidden="true">&rarr;</span></button>
                </li>

            </ul>
        </nav>
    </div>
</div>
<div id="tag" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">新标签</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="tag-name" class="control-label">名称:</label>
                        <input type="text" class="form-control" id="tag-name">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button id="add_tag" type="button" class="btn btn-primary">增加</button>
            </div>
        </div>
    </div>
</div>
<div id="modify" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">修改标签</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="tag-name" class="control-label">名称:</label>
                        <input type="text" class="form-control" id="modify-tag-name">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button id="modify_tag" type="button" class="btn btn-primary">修改</button>
            </div>
        </div>
    </div>
</div>
<div id="delete_modal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title">提示</h4>
            </div>
            <div class="modal-body">
                <p>确认要删除吗？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger modal-delete" data-dismiss="modal">Yes</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock body %}

{% block script %}
<script>
    "use strict";
    $(function () {
        getTags()
    });

    function getTags() {
        $.getJSON("/api/v1/tag/view?limit=10&&offset=" + page.page * 10, function (result) {
            if (result.data.length < 10) {
                $("#next").attr({"disabled": "disabled"});
            }
            var html = template("tpl-tag-list", result);
            $("tbody").append(html);
            deleteButton();
            modifyButton();
        })
    }

    $("button.pull-right").click(function (event) {
        event.preventDefault();
        $("#tag-name").val("");
        $("#tag").modal("show")
    });

    $("#add_tag").click(function () {
        var tag_name = $("#tag-name").val().replace(/(^\s*)|(\s*$)/g, "");
        if (tag_name === "") {
            $(".text-danger").remove();
            $(this).parent().prev().append("<span class='text-danger'>标签为空</span>")
        } else {
            $('#tag').modal('hide');
            $.ajax({
                url: "/api/v1/tag/new",
                type: "post",
                dataType: "json",
                data: JSON.stringify({"tag": tag_name}),
                headers: {"Content-Type": "application/json"},
                success: function (res) {
                    if (res.status) {

                    }
                }
            })
        }
    });

    function deleteButton() {
        $(".delete").on("click", function (event) {
            event.preventDefault();
            $("#delete_modal").modal("show");
            var tr = $(this).parent().parent();
            var id = $(this).attr("data-id");
            $(".modal-delete").click(function () {
                $.ajax({
                    url: "/api/v1/tag/delete/" + id,
                    type: "post",
                    dataType: "json",
                    data: "",
                    headers: {"Content-Type": "application/json"},
                    success: function (res) {
                        if (res.status) {
                            tr.hide(1000, function () {
                                tr.remove()
                            })
                        }
                    }
                })
            })
        })
    }

    function modifyButton() {
        $(".modify").on("click", function (event) {
            event.preventDefault();
            $("#modify").modal("show");
            var pre_tag = $(this).parent().prev().prev().children().text();
            var pre_tag_element = $(this).parent().prev().prev().children();
            $("#modify-tag-name").val(pre_tag);
            var id = $(this).attr("data-id");
            $("#modify_tag").click(function () {
                var tag_name = $("#modify-tag-name").val().replace(/(^\s*)|(\s*$)/g, "");
                if (tag_name === "" || tag_name === pre_tag) {
                    $(".text-danger").remove();
                    $(this).parent().prev().append("<span class='text-danger'>标签为空或未修改</span>")
                } else {
                    $.ajax({
                        url: "/api/v1/tag/edit",
                        type: "post",
                        dataType: "json",
                        data: JSON.stringify({"id": id, "tag": tag_name}),
                        headers: {"Content-Type": "application/json"},
                        success: function (res) {
                            if (res.status) {
                                pre_tag_element.text(tag_name);
                                $('#modify').modal('hide');
                            }
                        }
                    })
                }
            })
        })
    }

    $("#previous").click(function (event) {
        event.preventDefault();
        page.sub();
        $("#next").removeAttr("disabled");
        if (page.page === 0) {
            $("#previous").attr({"disabled": "disabled"});
        }
        $("tbody").html("");
        getTags();
    });

    $("#next").click(function (event) {
        event.preventDefault();
        page.add();
        if (page.page > 0) {
            $("#previous").removeAttr("disabled");
        }
        $("tbody").html("");
        getTags();
    });

    function Page() {
        this.page = 0;
        this.add = function () {
            this.page += 1;
        };
        this.sub = function () {
            this.page -= 1;
        }
    }

    var page = new Page();
</script>
{% endblock script %}
